<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üìñ Kimi Book Studio</title>
    <!-- –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { width: 100%; height: 100%; }
        body { 
            background: #0a0a0a; 
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        body { padding-top: max(12px, env(safe-area-inset-top)); }

        .app { display: flex; flex-direction: column; min-height: 100vh; }
        .app-header { 
            background: linear-gradient(135deg, #0dd 0%, #09a 100%);
            color: #000;
            padding: 16px 16px max(16px, env(safe-area-inset-bottom));
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 221, 221, 0.3);
            position: sticky; top: 0; z-index: 100;
        }
        .app-header h1 { font-size: 24px; font-weight: 600; }
        .app-header p { font-size: 12px; opacity: 0.8; margin-top: 4px; }

        .app-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

        /* TABS */
        .tabs { 
            display: flex; gap: 0; background: #1a1a1a;
            border-top: 1px solid #333; position: sticky; bottom: 0; z-index: 50;
        }
        .tab-btn { 
            flex: 1; background: none; border: none; color: #666; padding: 12px 8px;
            cursor: pointer; font-weight: 600; font-size: 12px;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            border-bottom: 3px solid transparent; transition: all 0.2s;
        }
        .tab-btn.active { color: #0dd; border-bottom-color: #0dd; }
        .tab-btn:active { background: rgba(0, 221, 221, 0.1); }

        .tab-content { flex: 1; overflow-y: auto; overflow-x: hidden; padding: 16px; padding-bottom: 80px; }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* BUTTONS */
        button {
            width: 100%; padding: 14px 16px; margin-bottom: 8px; border: none; border-radius: 8px;
            font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        button:active { transform: scale(0.98); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); }
        button.primary { background: linear-gradient(135deg, #0dd 0%, #09a 100%); color: #000; }
        button.secondary { background: #555; color: #fff; }
        button.success { background: linear-gradient(135deg, #0a0 0%, #080 100%); color: #fff; }
        button.danger { background: linear-gradient(135deg, #f55 0%, #d33 100%); color: #fff; }
        button.info { background: linear-gradient(135deg, #15f 0%, #13d 100%); color: #fff; }

        /* INPUTS */
        input[type="text"], textarea, select {
            width: 100%; padding: 12px 14px; margin-bottom: 12px; background: #1a1a1a;
            border: 1px solid #333; border-radius: 8px; color: #fff; font-size: 16px;
            font-family: inherit; transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus { outline: none; border-color: #0dd; box-shadow: 0 0 0 3px rgba(0, 221, 221, 0.1); }
        textarea { resize: vertical; min-height: 120px; font-family: 'Courier New', monospace; }

        /* FILE INPUT */
        input[type="file"] { display: none; }
        .file-btn {
            display: block; padding: 16px; background: #1a1a1a; border: 2px dashed #0dd;
            border-radius: 8px; text-align: center; cursor: pointer; margin-bottom: 12px;
            color: #0dd; font-weight: 600; font-size: 14px; transition: all 0.2s;
        }
        .file-btn:active { background: rgba(0, 221, 221, 0.1); }

        /* CARDS */
        .card {
            background: #1a1a1a; border: 1px solid #333; border-radius: 12px;
            padding: 14px; margin-bottom: 12px; box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        .card h3 { color: #0dd; font-size: 14px; margin-bottom: 10px; }

        /* LOG */
        .log-box {
            background: #000; border: 1px solid #333; border-radius: 8px; padding: 10px;
            font-size: 12px; max-height: 100px; overflow-y: auto; color: #0f0;
            font-family: 'Courier New', monospace; margin-bottom: 12px; line-height: 1.4;
        }

        .info-block {
            background: rgba(0, 221, 221, 0.1); border-left: 3px solid #0dd;
            padding: 10px 12px; border-radius: 6px; font-size: 13px; margin-bottom: 12px;
        }

        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 6px; margin-bottom: 12px; }
        .btn-group button { padding: 10px 8px; font-size: 11px; margin-bottom: 0; background: #333; color: #0dd; border: 1px solid #0dd; }

        .rename-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .rename-grid label { font-size: 12px; color: #999; display: block; margin-bottom: 4px; font-weight: 600; }
        .rename-grid input { margin-bottom: 8px; padding: 10px 12px; font-size: 14px; }

        #cover-preview {
            max-width: 140px; height: auto; max-height: 200px; border-radius: 8px;
            display: block; margin: 0 auto 12px; border: 1px solid #333; object-fit: cover;
        }

        /* MODAL */
        #rename-section {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.8); z-index: 200; display: none;
            flex-direction: column; justify-content: flex-end; animation: slideUp 0.3s ease-out;
        }
        #rename-section.show { display: flex; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .modal-content {
            background: #1a1a1a; padding: 20px; border-radius: 16px 16px 0 0;
            max-height: 80vh; overflow-y: auto; box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.5);
        }
        .modal-content h3 { color: #0dd; margin-bottom: 16px; font-size: 16px; }

        /* SCROLLBAR */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

        /* MEDIA QUERIES */
        @media (min-width: 768px) {
            body { font-size: 14px; }
            .tab-content { padding: 24px; padding-bottom: 120px; }
            .btn-group { grid-template-columns: 1fr 1fr; }
            .export-grid { display: grid; grid-template-columns: 180px 1fr; gap: 20px; align-items: start; }
        }
        @media (min-width: 1024px) {
            .app { flex-direction: row; }
            .app-header { writing-mode: vertical-rl; text-orientation: mixed; padding: 16px 12px; min-width: 200px; }
            .tabs { flex-direction: column; position: fixed; left: 0; top: 0; bottom: 0; width: auto; border-top: none; border-right: 1px solid #333; }
            .tab-btn { border-bottom: none; border-right: 3px solid transparent; }
            .tab-btn.active { border-right-color: #0dd; }
            .app-content { margin-left: 0; }
        }
        @media (max-width: 480px) {
            .rename-grid { grid-template-columns: 1fr; }
            .export-grid { display: flex; flex-direction: column; }
        }
    </style>
</head>
<body>

<div class="app">
    <div class="app-header">
        <h1>üìñ Kimi Studio</h1>
        <p>–¢–µ–∫—Å—Ç–æ–≤—ã–π —Ä–µ–¥–∞–∫—Ç–æ—Ä –¥–ª—è –∫–Ω–∏–≥</p>
    </div>

    <div class="app-content">
                    <a href="https://github.com/Roflsockie/Kimi-Studio#readme" target="_blank" style="color: #3dd; text-decoration: none; font-size: 12px;">üìñ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (README)</a>
        <div id="import" class="tab-pane active">
            <button class="secondary" onclick="clearLog()">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>
            <div class="log-box" id="log"></div>

            <div class="info-block">
                üí° –†–∞–∑–º–µ—Ç–∫–∞: <code>## –ì–ª–∞–≤–∞ 1</code> –∏–ª–∏ <code>## Chapter 1</code><br>
                –¢–µ–≥–∏: <code>[AI]: —Ç–µ–∫—Å—Ç</code>
            </div>

            <label class="file-btn" for="file">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</label>
            <input type="file" id="file" accept=".txt,.json,.html,.md">

            <textarea id="text" placeholder="–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å..."></textarea>

            <button class="primary" onclick="processText()">‚úÇÔ∏è –†–∞–∑–±–∏—Ç—å</button>
            <button class="primary" id="rename-btn" onclick="showRenameUI()" style="display:none">üî§ –ò–º–µ–Ω–∞</button>
            <button class="primary" onclick="formatText()">‚ú® –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
            <button class="secondary" onclick="downloadAllZip()">üì¶ ZIP</button>
            <button class="success" onclick="showTab('export')">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
            <button class="secondary" onclick="clearAll()">‚ö†Ô∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë</button>
        </div>

        <div id="chapters" class="tab-pane">
            <h2>üìö –ì–ª–∞–≤—ã</h2>
            <div id="chapters-list" class="chapters-list"></div>
        </div>

        <div id="export" class="tab-pane">
            <h2>üì§ –≠–∫—Å–ø–æ—Ä—Ç</h2>
            
            <div class="export-grid">
                <div style="text-align: center;">
                    <img id="cover-preview" style="display: none;" alt="–ü–æ—Å—Ç–µ—Ä">
                    <label class="file-btn" for="cover" style="font-size:12px; padding:8px;">üñºÔ∏è –ü–æ—Å—Ç–µ—Ä</label>
                    <input type="file" id="cover" accept="image/*">
                </div>

                <div style="width: 100%;">
                    <input type="text" id="book-title" placeholder="üìñ –ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏">
                    <input type="text" id="book-author" placeholder="‚úçÔ∏è –ê–≤—Ç–æ—Ä">
                    <input type="text" id="book-genre" placeholder="üé≠ –ñ–∞–Ω—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä: –§–∞–Ω—Ç–∞—Å—Ç–∏–∫–∞)">
                    <input type="text" id="book-date" placeholder="üìÖ –î–∞—Ç–∞ –Ω–∞–ø–∏—Å–∞–Ω–∏—è">
                    <textarea id="book-desc" placeholder="üìù –û–ø–∏—Å–∞–Ω–∏–µ –∫–Ω–∏–≥–∏..." style="min-height: 80px;"></textarea>
                </div>
            </div>

            <div style="margin-top: 20px;">
                <button class="danger" onclick="downloadFullTXT()">üìù TXT (–í—Å—è –∫–Ω–∏–≥–∞)</button>
                <button class="danger" onclick="downloadEPUB()">‚¨áÔ∏è EPUB (–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –∫–Ω–∏–≥–∞)</button>
                <button class="info" onclick="downloadHTML()">üåê HTML (–í–µ–±-–∫–Ω–∏–≥–∞ —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π)</button>
            </div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('import')">üì• –ò–º–ø–æ—Ä—Ç</button>
        <button class="tab-btn" onclick="showTab('chapters')">üìö –ì–ª–∞–≤—ã</button>
        <button class="tab-btn" onclick="showTab('export')">üì§ –≠–∫—Å–ø–æ—Ä—Ç</button>
    </div>
</div>

<div id="rename-section">
    <div class="modal-content">
        <h3>–ü–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π</h3>
        <div id="rename-fields" class="rename-grid"></div>
        <button class="primary" onclick="applyRenames(); closeModal()">‚úì –ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        <button class="secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
let state = {
    chapters: [],
    uniqueTags: new Set(),
    tagMap: {},
    cover: null
};
let logs = [];

function normalizeSpaces(text) {
    return text.replace(/\u00A0/g, ' ').replace(/\u2002/g, ' ').replace(/\u2003/g, ' ').replace(/  +/g, ' ').replace(/\u200B/g, '').trim();
}

function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function stripHtmlTags(text) {
    return text.replace(/<[^>]*>/g, '');
}

function log(msg) {
    logs.push(msg);
    const logEl = document.getElementById('log');
    logEl.textContent = logs.join('\n');
    logEl.scrollTop = logEl.scrollHeight;
}

function clearLog() {
    logs = [];
    document.getElementById('log').textContent = '';
}

function showTab(name) {
    document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    document.querySelector(`[onclick*="showTab('${name}')"]`).classList.add('active');
}

function closeModal() {
    document.getElementById('rename-section').classList.remove('show');
}

document.getElementById('file').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
        let text = evt.target.result;
        if (file.name.endsWith('.json')) {
            try {
                const json = JSON.parse(text);
                let msgs = Array.isArray(json) ? json : json.messages || json.data || json.chats || [];
                if (!msgs.length) for (let k in json) if (Array.isArray(json[k])) { msgs = json[k]; break; }
                text = msgs.map(m => typeof m === 'string' ? m : m.text || m.message || m.content || '').filter(t => t.trim()).join('\n');
            } catch(e) {}
        }
        document.getElementById('text').value = text;
        log('‚úì –§–∞–π–ª: ' + file.name);
    };
    reader.readAsText(file);
});

document.getElementById('cover').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
        state.cover = evt.target.result;
        document.getElementById('cover-preview').src = evt.target.result;
        document.getElementById('cover-preview').style.display = 'block';
        log('‚úì –ü–æ—Å—Ç–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω');
    };
    reader.readAsDataURL(file);
});

function processText() {
    const raw = document.getElementById('text').value;
    if (!raw.trim()) { 
        alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!'); 
        return; 
    }
    
    state.chapters = [];
    state.uniqueTags = new Set();
    
    // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç—Ä–æ–∫–∏
    let lines = raw.split('\n');
    let chTitle = null;
    let chContent = [];

    // –£–õ–£–ß–®–ï–ù–ù–û–ï —Ä–µ–≥—É–ª—è—Ä–Ω–æ–µ –≤—ã—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –ø–æ–∏—Å–∫–∞ –≥–ª–∞–≤
    // –ù–∞—Ö–æ–¥–∏—Ç: ## –ì–ª–∞–≤–∞ 1, ## Chapter 1: –ù–∞—á–∞–ª–æ, [AI]: ## –ì–ª–∞–≤–∞ 1, ## –ü—Ä–æ–ª–æ–≥ –∏ —Ç.–¥.
    const chapterRegex = /^(.*)##\s+(.+)$/i;

    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        
        // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –Ω–∞—á–∞–ª–µ –¥–æ–∫—É–º–µ–Ω—Ç–∞
        if (!line && chTitle === null) continue;
        
        let match = line.match(chapterRegex);

        if (match) {
            // –ï—Å–ª–∏ –º—ã –Ω–∞—à–ª–∏ –Ω–æ–≤—É—é –≥–ª–∞–≤—É, —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é (–µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞)
            if (chTitle !== null) {
                state.chapters.push({ 
                    title: chTitle, 
                    fullBody: chContent.join('\n').trim() 
                });
            }

            // match[1] - —ç—Ç–æ —Ç–æ, —á—Ç–æ –î–û ## (–Ω–∞–ø—Ä–∏–º–µ—Ä, [AI]: –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–æ–±–µ–ª—ã)
            // match[2] - —ç—Ç–æ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–ª–∞–≤—ã –ø–æ—Å–ª–µ ##
            let prefix = match[1].trim(); 
            chTitle = match[2].trim();    
            chContent = [];

            // –ï—Å–ª–∏ –ø–µ—Ä–µ–¥ ## –±—ã–ª —Ç–µ–≥ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞, –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –µ–≥–æ
            if (prefix) {
                // –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–≥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [–ò–º—è] –∏–ª–∏ [–ò–º—è]:
                const tagMatch = prefix.match(/\[([^\]]+)\]:?/);
                if (tagMatch) {
                    const tagName = tagMatch[1];
                    state.uniqueTags.add(tagName);
                    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–≥ –≤ –Ω–∞—á–∞–ª–æ –≥–ª–∞–≤—ã (–º–æ–∂–Ω–æ –∑–∞–∫–æ–º–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å)
                    chContent.push(prefix);
                }
            }
        } else if (chTitle !== null) {
            // –ï—Å–ª–∏ –º—ã —É–∂–µ –≤–Ω—É—Ç—Ä–∏ –≥–ª–∞–≤—ã, –∫–æ–ø–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫–∏ —Ç–µ–∫—Å—Ç–∞ (—Å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ–±–µ–ª–∞–º–∏)
            chContent.push(lines[i]);
            
            // –ò—â–µ–º –≤—Å–µ —Ç–µ–≥–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π –≤ —Ç–µ–∫—Å—Ç–µ –¥–ª—è —Ñ—É–Ω–∫—Ü–∏–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è
            // –ù–∞—Ö–æ–¥–∏–º: [–ò–º—è], [–ò–º—è]:, –ò–º—è:
            const tagsInLine = line.match(/\[([^\]]+)\]:?/g);
            if (tagsInLine) {
                tagsInLine.forEach(t => {
                    const cleanTag = t.replace(/[\[\]:]/g, '');
                    state.uniqueTags.add(cleanTag);
                });
            }
            
            // –¢–∞–∫–∂–µ –∏—â–µ–º —Ç–µ–≥–∏ –±–µ–∑ —Å–∫–æ–±–æ–∫ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏ (—Ñ–æ—Ä–º–∞—Ç "–ò–º—è: —Ç–µ–∫—Å—Ç")
            const simpleTagMatch = line.match(/^([A-Za-z–ê-–Ø–∞-—è–Å—ë\s]+):\s+/);
            if (simpleTagMatch && simpleTagMatch[1].length < 30) { // –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –¥–ª–∏–Ω—ã –∏–º–µ–Ω–∏
                state.uniqueTags.add(simpleTagMatch[1].trim());
            }
        }
    }
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–∞–º—É—é –ø–æ—Å–ª–µ–¥–Ω—é—é –≥–ª–∞–≤—É —Ñ–∞–π–ª–∞
    if (chTitle !== null && chContent.length > 0) {
        state.chapters.push({ 
            title: chTitle, 
            fullBody: chContent.join('\n').trim() 
        });
    }
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
    if (state.chapters.length === 0) {
        alert('–ì–ª–∞–≤—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!\n\n–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≥–ª–∞–≤—ã –ø–æ–º–µ—á–µ–Ω—ã —Å–∏–º–≤–æ–ª–∞–º–∏ ##\n\n–ü—Ä–∏–º–µ—Ä—ã:\n## –ì–ª–∞–≤–∞ 1\n## Chapter One: –ù–∞—á–∞–ª–æ\n[AI]: ## –ü—Ä–æ–ª–æ–≥');
        return;
    }
    
    log(`‚úì –£—Å–ø–µ—à–Ω–æ! –ù–∞–π–¥–µ–Ω–æ –≥–ª–∞–≤: ${state.chapters.length}`);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è, –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã —Ç–µ–≥–∏
    if (state.uniqueTags.size > 0) {
        document.getElementById('rename-btn').style.display = 'block';
        log(`  –ù–∞–π–¥–µ–Ω–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö —Ç–µ–≥–æ–≤: ${state.uniqueTags.size}`);
    }
    
    renderChapters();
    showTab('chapters');
}

function addChapter(title, body) {
    const tags = [];
    const tagRe = /^\s*(\[[^\]]+\]:?)\s*/;
    while (tagRe.test(body)) {
        const m = body.match(tagRe);
        const tag = m[1].replace(/:$/, '');
        tags.push(tag);
        state.uniqueTags.add(tag);
        body = body.substring(m[0].length);
    }
    body = body.trim();
    let fullBody = body;
    if (tags.length) fullBody = tags.map(t => t + ': ').join('') + '\n\n' + body;
    state.chapters.push({ title: title, body: body, tags: tags, fullBody: fullBody });
}

function showRenameUI() {
    const fieldsDiv = document.getElementById('rename-fields');
    fieldsDiv.innerHTML = '';
    const tags = Array.from(state.uniqueTags);
    tags.forEach(tag => {
        const cleanTag = tag.replace(/[\[\]]/g, '');
        const label = document.createElement('label');
        label.textContent = tag + ':';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = '–ù–æ–≤–æ–µ –∏–º—è...';
        input.id = 'rename-' + cleanTag;
        fieldsDiv.appendChild(label);
        fieldsDiv.appendChild(input);
    });
    document.getElementById('rename-section').classList.add('show');
}

function applyRenames() {
    const tags = Array.from(state.uniqueTags);
    const newNames = {};
    tags.forEach(tag => {
        const cleanTag = tag.replace(/[\[\]]/g, '');
        const input = document.getElementById('rename-' + cleanTag);
        if (input && input.value.trim()) newNames[tag] = input.value.trim();
    });
    
    if (Object.keys(newNames).length === 0) { alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–º—è!'); return; }
    
    state.chapters.forEach(ch => {
        let body = ch.fullBody;
        Object.keys(newNames).forEach(oldTag => {
            const newName = newNames[oldTag];
            const cleanOldTag = oldTag.replace(/[\[\]]/g, '').replace(/:$/, '');
            const replacement = '<b>' + newName + ':</b> ';
            body = body.replace(new RegExp('^\\s*\\[' + cleanOldTag + '\\]:\\s*', 'gm'), replacement);
            body = body.replace(new RegExp('^\\s*\\[' + cleanOldTag + '\\]\\s+', 'gm'), replacement);
            body = body.replace(new RegExp('^' + cleanOldTag + ':\\s*', 'gm'), replacement);
        });
        ch.fullBody = body;
        ch.body = body;
    });
    
    renderChapters();
    log('‚úì –¢–µ–≥–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω—ã');
}

function formatText() {
    state.chapters.forEach(ch => {
        let body = ch.fullBody;
        let parts = body.split(/(<[^>]*>)/);
        parts = parts.map((part, idx) => {
            if (idx % 2 === 1) return part;
            let text = part;
            text = text.replace(/\\/g, '');
            text = text.replace(/_([^_]+)_/g, '$1');
            text = text.replace(/\/([^/]+)\//g, '$1');
            text = text.replace(/(\*(?!\*))([^\*]+)\1(?!\*)/g, '$2');
            text = text.replace(/"([^"]*)"/g, '¬´$1¬ª');
            text = text.replace(/(\n|\s)-\s/g, '$1‚Äî ');
            return text;
        });
        ch.fullBody = parts.join('');
        ch.body = ch.fullBody;
    });
    renderChapters();
    log('‚úì –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ');
}

function renderChapters() {
    const list = document.getElementById('chapters-list');
    list.innerHTML = '';
    
    // –ê–≤—Ç–æ–æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —è–∑—ã–∫–∞ –ø–æ –ø–µ—Ä–≤–æ–π –≥–ª–∞–≤–µ
    let defaultChapterWord = '–ì–ª–∞–≤–∞'; // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä—É—Å—Å–∫–∏–π
    
    if (state.chapters.length > 0) {
        const firstTitle = state.chapters[0].title;
        // –ï—Å–ª–∏ –ø–µ—Ä–≤–∞—è –≥–ª–∞–≤–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å –∞–Ω–≥–ª–∏–π—Å–∫–∏—Ö —Å–ª–æ–≤ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–Ω–≥–ª–∏–π—Å–∫–∏–π
        if (/^(Chapter|Part)/i.test(firstTitle)) {
            defaultChapterWord = 'Chapter';
        }
    }
    
    state.chapters.forEach((ch, i) => {
        const div = document.createElement('div');
        div.className = 'card';
        
        // –£–º–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞ –≥–ª–∞–≤—ã
        let displayTitle = ch.title;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å "–ì–ª–∞–≤–∞ X" –∏–ª–∏ "Chapter X"
        const chapterPrefixMatch = displayTitle.match(/^(–ì–ª–∞–≤–∞|Chapter|–ß–∞—Å—Ç—å|Part)\s+(\d+)/i);
        
        if (chapterPrefixMatch) {
            // –ï—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å "–ì–ª–∞–≤–∞ X" - –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
            displayTitle = ch.title;
        } else {
            // –ï—Å–ª–∏ –Ω–µ—Ç –ø—Ä–µ—Ñ–∏–∫—Å–∞ - –¥–æ–±–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º —è–∑—ã–∫–µ
            displayTitle = `${defaultChapterWord} ${i+1}: ${ch.title}`;
        }
        
        div.innerHTML = `
            <h3>${displayTitle}</h3>
            <div class="btn-group">
                <button onclick="downloadChapter(${i})" style="background: #333; color: #0dd; border: 1px solid #0dd;">üíæ</button>
                <button onclick="downloadChapterHTML(${i})" style="background: #333; color: #0dd; border: 1px solid #0dd;">üåê</button>
                <button onclick="deleteChapter(${i})" style="background: #333; color: #f55; border: 1px solid #f55;">üóëÔ∏è</button>
            </div>
            <textarea id="ch${i}" onchange="state.chapters[${i}].fullBody = this.value; state.chapters[${i}].body = this.value;" style="font-size: 12px; min-height: 80px;">${escapeHtml(ch.fullBody)}</textarea>
        `;
        list.appendChild(div);
    });
}

function ensureTagFormatting(text) {
    let processed = text;
    processed = processed.replace(/^\[([^\]]+)\]:?\s*/gm, '<b>$1:</b> ');
    return processed;
}

function formatChapterForHTML(content) {
    const lines = content.split('\n');
    let html = '';
    for (let i = 0; i < lines.length; i++) {
        // –ñ–ï–°–¢–ö–ê–Ø –û–ß–ò–°–¢–ö–ê –ü–†–û–ë–ï–õ–û–í
        let line = lines[i].replace(/\s+/g, ' ').trim(); 
        if (!line) continue;
        
        const boldMatch = line.match(/^<b>([^<]+)<\/b>\s*(.*)$/);
        if (boldMatch) {
            const name = boldMatch[1];
            const rest = normalizeSpaces(boldMatch[2]);
            if (rest) html += '<p><strong>' + escapeHtml(name) + '</strong> ' + escapeHtml(rest) + '</p>';
            else html += '<p><strong>' + escapeHtml(name) + '</strong></p>';
        } else {
            const normalized = normalizeSpaces(escapeHtml(line));
            if (normalized) html += '<p>' + normalized + '</p>';
        }
    }
    return html;
}

function downloadChapter(i) {
    const ch = state.chapters[i];
    let txt = ch.fullBody;
    txt = ensureTagFormatting(txt);
    txt = txt.replace(/\n(<b>[^<]+<\/b>)/g, '\n\n$1');
    txt = stripHtmlTags(txt);
    const header = '–ì–ª–∞–≤–∞ ' + (i+1) + ': ' + ch.title + '\n\n';
    txt = header + txt;
    const blob = new Blob([txt], { type: 'text/plain; charset=utf-8' });
    saveAs(blob, '–ì–ª–∞–≤–∞_' + (i+1) + '_' + ch.title + '.txt');
    log('‚úì –°–∫–∞—á–∞–Ω–∞ –≥–ª–∞–≤–∞ ' + (i+1));
}

function downloadChapterHTML(i) {
    const ch = state.chapters[i];
    let txt = ensureTagFormatting(ch.fullBody);
    const htmlBody = formatChapterForHTML(txt);
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${ch.title}</title><style>body{font-family:Georgia,serif;padding:20px;line-height:1.6;max-width:600px;margin:0 auto}</style></head><body><h2>${ch.title}</h2>${htmlBody}</body></html>`;
    const blob = new Blob([html], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = '–ì–ª–∞–≤–∞_' + (i+1) + '_' + ch.title + '.html';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function deleteChapter(i) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –ì–ª–∞–≤–∞ ' + (i+1) + '?')) {
        state.chapters.splice(i, 1);
        renderChapters();
        log('‚úì –£–¥–∞–ª–µ–Ω–∞ –≥–ª–∞–≤–∞ ' + (i+1));
    }
}

function downloadAllZip() {
    if (!state.chapters.length) { alert('–ù–µ—Ç –≥–ª–∞–≤!'); return; }
    const zip = new JSZip();
    state.chapters.forEach((ch, i) => {
        let txt = ensureTagFormatting(ch.fullBody);
        txt = txt.replace(/\n(<b>[^<]+<\/b>)/g, '\n\n$1');
        txt = stripHtmlTags(txt);
        const header = '–ì–ª–∞–≤–∞ ' + (i+1) + ': ' + ch.title + '\n\n';
        txt = header + txt;
        zip.file('–ì–ª–∞–≤–∞_' + (i+1) + '_' + ch.title + '.txt', txt);
    });
    zip.generateAsync({ type: 'blob' }).then(blob => {
        saveAs(blob, '–ö–Ω–∏–≥–∞_–≤—Å–µ_–≥–ª–∞–≤—ã.zip');
        log('‚úì ZIP —Å–∫–∞—á–∞–Ω');
    });
}

function downloadFullTXT() {
    if (!state.chapters.length) { alert('–ù–µ—Ç –≥–ª–∞–≤!'); return; }
    const title = document.getElementById('book-title').value || '–ö–Ω–∏–≥–∞';
    const author = document.getElementById('book-author').value || '';
    const genre = document.getElementById('book-genre').value || '';
    const date = document.getElementById('book-date').value || '';
    const desc = document.getElementById('book-desc').value || '';
    
    let txt = '=== ' + title.toUpperCase() + ' ===\n';
    if (author) txt += '–ê–≤—Ç–æ—Ä: ' + author + '\n';
    if (genre) txt += '–ñ–∞–Ω—Ä: ' + genre + '\n';
    if (date) txt += '–î–∞—Ç–∞: ' + date + '\n';
    if (desc) txt += '\n–û–ø–∏—Å–∞–Ω–∏–µ:\n' + desc + '\n';
    txt += '\n' + '='.repeat(60) + '\n\n';
    
    for (let i = 0; i < state.chapters.length; i++) {
        const ch = state.chapters[i];
        txt += '–ì–õ–ê–í–ê ' + (i+1) + ': ' + ch.title.toUpperCase() + '\n\n';
        let chapterTxt = ensureTagFormatting(ch.fullBody);
        chapterTxt = chapterTxt.replace(/\n(<b>[^<]+<\/b>)/g, '\n\n$1');
        chapterTxt = stripHtmlTags(chapterTxt);
        txt += chapterTxt + '\n\n';
        txt += '-'.repeat(60) + '\n\n';
    }
    saveAs(new Blob([txt], { type: 'text/plain; charset=utf-8' }), title + '_–ø–æ–ª–Ω–∞—è_–∫–Ω–∏–≥–∞.txt');
    log('‚úì TXT —Å–∫–∞—á–∞–Ω');
}

function downloadEPUB() {
    if (!state.chapters.length) { alert('–ù–µ—Ç –≥–ª–∞–≤!'); return; }
    const title = document.getElementById('book-title').value || '–ö–Ω–∏–≥–∞';
    const author = document.getElementById('book-author').value || '–ê–≤—Ç–æ—Ä';
    const genre = document.getElementById('book-genre').value || '';
    const desc = document.getElementById('book-desc').value || '';
    
    const zip = new JSZip();
    zip.file('mimetype', 'application/epub+zip');
    zip.folder('META-INF').file('container.xml', `<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>`);
    const oebps = zip.folder('OEBPS');
    
    let manifest = '<item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>';
    let spine = '';
    state.chapters.forEach((_, i) => {
        manifest += `\n<item id="ch${i}" href="ch${i}.xhtml" media-type="application/xhtml+xml"/>`;
        spine += `\n<itemref idref="ch${i}"/>`;
    });
    if (state.cover) {
        manifest += '\n<item id="cover-image" href="cover.png" media-type="image/png"/>';
        oebps.file('cover.png', state.cover.split(',')[1], { base64: true });
    }
    
    let opf = `<?xml version="1.0" encoding="UTF-8"?><package xmlns="http://www.idpf.org/2007/opf" version="2.0" unique-identifier="uuid"><metadata xmlns:dc="http://purl.org/dc/elements/1.1/"><dc:title>${escapeHtml(title)}</dc:title><dc:creator>${escapeHtml(author)}</dc:creator><dc:subject>${escapeHtml(genre)}</dc:subject><dc:description>${escapeHtml(desc)}</dc:description>`;
    if (state.cover) opf += `<meta name="cover" content="cover-image"/>`;
    opf += `</metadata><manifest>${manifest}</manifest><spine toc="ncx">${spine}</spine></package>`;
    oebps.file('content.opf', opf);
    
    let navMap = '';
    state.chapters.forEach((ch, i) => {
        navMap += `\n<navPoint id="ch${i}" playOrder="${i+1}"><navLabel><text>${escapeHtml(ch.title)}</text></navLabel><content src="ch${i}.xhtml"/></navPoint>`;
    });
    oebps.file('toc.ncx', `<?xml version="1.0"?><ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1"><navMap>${navMap}</navMap></ncx>`);
    
    state.chapters.forEach((ch, i) => {
        let processedBody = ensureTagFormatting(ch.fullBody);
        const htmlBody = formatChapterForHTML(processedBody);
        const xhtml = `<?xml version="1.0" encoding="utf-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><title>${escapeHtml(ch.title)}</title><style>p{margin-bottom:1em;line-height:1.6} strong{font-weight:bold}</style></head><body><h2>${escapeHtml(ch.title)}</h2>${htmlBody}</body></html>`;
        oebps.file(`ch${i}.xhtml`, xhtml);
    });
    
    zip.generateAsync({ type: 'blob' }).then(blob => {
        saveAs(blob, title + '.epub');
        log('‚úì EPUB —Å–∫–∞—á–∞–Ω');
    });
}

function downloadHTML() {
    if (!state.chapters.length) { alert('–ù–µ—Ç –≥–ª–∞–≤!'); return; }
    
    const title = document.getElementById('book-title').value || '–ö–Ω–∏–≥–∞';
    const author = document.getElementById('book-author').value || '';
    const genre = document.getElementById('book-genre').value || '';
    const desc = document.getElementById('book-desc').value || '';
    const date = document.getElementById('book-date').value || '';
    
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –û–≥–ª–∞–≤–ª–µ–Ω–∏—è
    let tocHtml = `<div id="toc" class="toc"><h3>–û–≥–ª–∞–≤–ª–µ–Ω–∏–µ</h3><ul style="list-style:none;padding:0;">`;
    let chaptersHtml = '';
    
    state.chapters.forEach((ch, i) => {
        const id = `ch-${i}`;
        // –°—Å—ã–ª–∫–∞ –≤ –æ–≥–ª–∞–≤–ª–µ–Ω–∏–∏
        tocHtml += `<li><a href="#${id}" style="text-decoration:none;color:#007bff;display:block;margin-bottom:5px;">–ì–ª–∞–≤–∞ ${i+1}: ${escapeHtml(ch.title)}</a></li>`;
        
        let processedBody = ensureTagFormatting(ch.fullBody);
        const htmlBody = formatChapterForHTML(processedBody);
        
        // –¢–µ–ª–æ –≥–ª–∞–≤—ã —Å ID –∏ —Å—Å—ã–ª–∫–æ–π –≤–æ–∑–≤—Ä–∞—Ç–∞
        chaptersHtml += `
            <div class="chapter">
                <h2 id="${id}">–ì–ª–∞–≤–∞ ${i+1}: ${ch.title}</h2>
                ${htmlBody}
                <div style="margin-top:20px;text-align:right;">
                    <a href="#toc" style="color:#999;text-decoration:none;font-size:14px;">‚Üë –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–≥–ª–∞–≤–ª–µ–Ω–∏—é</a>
                </div>
            </div><hr>`;
    });
    tocHtml += `</ul></div>`;
    
    let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${title}</title><style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:Georgia,serif;background:#f5f5f5;color:#333;padding:15px;line-height:1.8}
.container{max-width:900px;margin:0 auto;background:white;padding:40px;border-radius:8px;box-shadow:0 2px 15px rgba(0,0,0,0.1)}
.book-header{text-align:center;border-bottom:2px solid #ddd;padding-bottom:30px;margin-bottom:40px}
.cover-img{max-width:300px;height:auto;display:block;margin:0 auto 20px;border-radius:4px;box-shadow:0 4px 10px rgba(0,0,0,0.2)}
h1{font-size:32px;margin-bottom:10px;color:#222}
.meta{color:#666;font-style:italic;margin-bottom:20px}
.desc{background:#f9f9f9;padding:20px;text-align:left;border-radius:6px;color:#555;margin-top:20px}
.toc{background:#f0f0f0;padding:20px;border-radius:8px;margin-bottom:40px;}
h2{margin-top:40px;margin-bottom:20px;font-size:24px;color:#444}
p{margin-bottom:15px;text-align:justify}
strong{font-weight:bold;color:#000}
hr{border:0;height:1px;background:#eee;margin:50px 0}
@media(max-width:768px){.container{padding:20px}h1{font-size:24px}h2{font-size:18px}}
</style></head><body><div class="container">`;

    html += `<div class="book-header">`;
    if (state.cover) html += `<img src="${state.cover}" class="cover-img" alt="–û–±–ª–æ–∂–∫–∞">`;
    html += `<h1>${escapeHtml(title)}</h1>`;
    html += `<div class="meta">`;
    if (author) html += `<span>${escapeHtml(author)}</span>`;
    if (genre) html += ` ‚Ä¢ <span>${escapeHtml(genre)}</span>`;
    if (date) html += ` ‚Ä¢ <span>${escapeHtml(date)}</span>`;
    html += `</div>`;
    if (desc) html += `<div class="desc">${escapeHtml(desc)}</div>`;
    html += `</div>`; 

    // –í—Å—Ç–∞–≤–ª—è–µ–º –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ –∏ –ì–ª–∞–≤—ã
    html += tocHtml;
    html += `<div class="content">${chaptersHtml}</div></div></body></html>`;
    
    const blob = new Blob([html], { type: 'text/html; charset=utf-8' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = title + '.html';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    log('‚úì HTML —Å–∫–∞—á–∞–Ω');
}

function clearAll() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')) {
        state = { chapters: [], uniqueTags: new Set(), tagMap: {}, cover: null };
        document.getElementById('text').value = '';
        document.getElementById('chapters-list').innerHTML = '';
        document.getElementById('rename-btn').style.display = 'none';
        log('‚úì –û—á–∏—â–µ–Ω–æ');
    }
}
</script>

</body>
</html>
