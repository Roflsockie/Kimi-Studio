<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0a0a0a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>üìñ Kimi Book Studio</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        html, body { width: 100%; height: 100%; }
        body { 
            background: #0a0a0a; 
            color: #fff; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            font-size: 16px;
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        /* SAFE AREA –¥–ª—è iPhone —Å notch */
        body { padding-top: max(12px, env(safe-area-inset-top)); }

        /* –ö–û–ù–¢–ï–ô–ù–ï–† –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø */
        .app { display: flex; flex-direction: column; min-height: 100vh; }
        .app-header { 
            background: linear-gradient(135deg, #0dd 0%, #09a 100%);
            color: #000;
            padding: 16px 16px max(16px, env(safe-area-inset-bottom));
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 221, 221, 0.3);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-header h1 { font-size: 24px; font-weight: 600; }
        .app-header p { font-size: 12px; opacity: 0.8; margin-top: 4px; }

        .app-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

        /* –í–ö–õ–ê–î–ö–ò (BOTTOM NAVIGATION STYLE) */
        .tabs { 
            display: flex; 
            gap: 0;
            background: #1a1a1a;
            border-top: 1px solid #333;
            position: sticky;
            bottom: 0;
            z-index: 50;
        }
        .tab-btn { 
            flex: 1;
            background: none;
            border: none;
            color: #666;
            padding: 12px 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
            -webkit-user-select: none;
        }
        .tab-btn.active { 
            color: #0dd;
            border-bottom-color: #0dd;
        }
        .tab-btn:active { background: rgba(0, 221, 221, 0.1); }

        /* –°–û–î–ï–†–ñ–ò–ú–û–ï –í–ö–õ–ê–î–û–ö */
        .tab-content { 
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 16px;
            padding-bottom: 80px;
        }
        .tab-pane { display: none; }
        .tab-pane.active { display: block; }

        /* –ö–ù–û–ü–ö–ò - MATERIAL DESIGN */
        button {
            width: 100%;
            padding: 14px 16px;
            margin-bottom: 8px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            -webkit-user-select: none;
            user-select: none;
        }
        button:active { transform: scale(0.98); box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        button.primary {
            background: linear-gradient(135deg, #0dd 0%, #09a 100%);
            color: #000;
        }
        button.secondary { background: #555; color: #fff; }
        button.success { background: linear-gradient(135deg, #0a0 0%, #080 100%); color: #fff; }
        button.danger { background: linear-gradient(135deg, #f55 0%, #d33 100%); color: #fff; }
        button.info { background: linear-gradient(135deg, #15f 0%, #13d 100%); color: #fff; }

        /* –ò–ù–ü–£–¢–´ –ò TEXTAREA */
        input[type="text"], textarea, select {
            width: 100%;
            padding: 12px 14px;
            margin-bottom: 12px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 8px;
            color: #fff;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #0dd;
            box-shadow: 0 0 0 3px rgba(0, 221, 221, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 120px;
            font-family: 'Courier New', monospace;
        }

        /* –§–ê–ô–õ –ó–ê–ì–†–£–ó–ö–ê */
        input[type="file"] { display: none; }
        .file-btn {
            display: block;
            padding: 16px;
            background: #1a1a1a;
            border: 2px dashed #0dd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 12px;
            color: #0dd;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }
        .file-btn:active { background: rgba(0, 221, 221, 0.1); }

        /* –ö–ê–†–¢–û–ß–ö–ò */
        .card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 12px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        .card h3 { color: #0dd; font-size: 14px; margin-bottom: 10px; }

        /* –õ–û–ì –ë–û–ö */
        .log-box {
            background: #000;
            border: 1px solid #333;
            border-radius: 8px;
            padding: 10px;
            font-size: 12px;
            max-height: 100px;
            overflow-y: auto;
            color: #0f0;
            font-family: 'Courier New', monospace;
            margin-bottom: 12px;
            line-height: 1.4;
        }

        /* –ò–ù–§–û–†–ú–ê–¶–ò–û–ù–ù–´–ô –ë–õ–û–ö */
        .info-block {
            background: rgba(0, 221, 221, 0.1);
            border-left: 3px solid #0dd;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            margin-bottom: 12px;
            line-height: 1.5;
        }

        /* –ö–ù–û–ü–ö–ò –ì–†–£–ü–ü–ê */
        .btn-group {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 6px;
            margin-bottom: 12px;
        }
        .btn-group button {
            padding: 10px 8px;
            font-size: 11px;
            margin-bottom: 0;
            background: #333;
            color: #0dd;
            border: 1px solid #0dd;
        }

        /* –ü–û–õ–Ø –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–Ø */
        .rename-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 12px;
        }
        .rename-grid label {
            font-size: 12px;
            color: #999;
            display: block;
            margin-bottom: 4px;
            font-weight: 600;
        }
        .rename-grid input {
            margin-bottom: 8px;
            padding: 10px 12px;
            font-size: 14px;
        }

        /* –°–ü–ò–°–û–ö –ì–õ–ê–í */
        .chapters-list { display: flex; flex-direction: column; gap: 12px; }

        /* –ò–ó–û–ë–†–ê–ñ–ï–ù–ò–ï –û–ë–õ–û–ñ–ö–ò */
        #cover-preview {
            max-width: 100%;
            height: auto;
            max-height: 200px;
            border-radius: 8px;
            display: block;
            margin: 0 auto 12px;
        }

        /* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û (–ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ) */
        #rename-section {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 200;
            display: none;
            flex-direction: column;
            justify-content: flex-end;
            animation: slideUp 0.3s ease-out;
        }
        #rename-section.show { display: flex; }

        @keyframes slideUp {
            from { transform: translateY(100%); }
            to { transform: translateY(0); }
        }

        .modal-content {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 16px 16px 0 0;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.5);
        }
        .modal-content h3 { color: #0dd; margin-bottom: 16px; font-size: 16px; }

        /* –°–ö–†–û–õ–õ –°–¢–ò–õ–¨ */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* –¢–ï–ö–°–¢ */
        h2 { color: #0dd; font-size: 16px; margin: 12px 0 8px 0; font-weight: 600; }
        code { background: #222; padding: 2px 6px; border-radius: 4px; color: #0f0; font-size: 12px; }

        /* –ß–ï–ö–ü–û–ò–ù–¢–´ –®–ò–†–ò–ù–´ */
        @media (min-width: 768px) {
            body { font-size: 14px; }
            .tab-content { padding: 24px; padding-bottom: 120px; }
            .btn-group { grid-template-columns: 1fr 1fr; }
            button { padding: 12px 16px; }
        }

        @media (min-width: 1024px) {
            .app { flex-direction: row; }
            .app-header { writing-mode: vertical-rl; text-orientation: mixed; padding: 16px 12px; min-width: 200px; }
            .tabs { flex-direction: column; position: fixed; left: 0; top: 0; bottom: 0; width: auto; border-top: none; border-right: 1px solid #333; }
            .tab-btn { border-bottom: none; border-right: 3px solid transparent; }
            .tab-btn.active { border-right-color: #0dd; }
            .app-content { margin-left: 0; }
        }

        /* –°–ö–†–´–í–ê–¢–¨ –≠–õ–ï–ú–ï–ù–¢–´ –ù–ê –ú–û–ë–ò–õ–¨–ù–´–• */
        @media (max-width: 480px) {
            .rename-grid { grid-template-columns: 1fr; }
            button { font-size: 13px; padding: 12px 14px; }
            .app-header h1 { font-size: 20px; }
        }
    </style>
</head>
<body>

<div class="app">
    <div class="app-header">
        <h1>üìñ Kimi Studio</h1>
        <p>Book text editor</p>
    </div>

    <div class="app-content">
        <div id="import" class="tab-pane active">
            <button class="secondary" onclick="clearLog()">üóëÔ∏è Clear log</button>
            <div class="log-box" id="log"></div>

            <div class="info-block">
                üí° Markup: <code>## Chapter 1 Title</code><br>
                Tags: <code>[AI]: text</code>
            </div>

            <label class="file-btn" for="file">üìÅ Load file</label>
            <input type="file" id="file" accept=".txt,.json,.html,.md">

            <textarea id="text" placeholder="–ò–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∑–¥–µ—Å—å..."></textarea>

            <button class="primary" onclick="processText()">‚úÇÔ∏è Split</button>
            <button class="primary" id="rename-btn" onclick="showRenameUI()" style="display:none">üî§ Names</button>
            <button class="primary" onclick="formatText()">‚ú® Format</button>
            <button class="secondary" onclick="downloadAllZip()">üì¶ ZIP</button>
            <button class="success" onclick="showTab('export')">üì§ Export</button>
            <button class="secondary" onclick="clearAll()">‚ö†Ô∏è Clear all</button>
        </div>

        <div id="chapters" class="tab-pane">
            <h2>üìö Chapters</h2>
            <div id="chapters-list" class="chapters-list"></div>
        </div>

        <div id="export" class="tab-pane">
            <h2>üì§ Export</h2>
            
            <input type="text" id="book-title" placeholder="üìñ –ù–∞–∑–≤–∞–Ω–∏–µ">
            <input type="text" id="book-author" placeholder="‚úçÔ∏è –ê–≤—Ç–æ—Ä">
            <input type="text" id="book-date" placeholder="üìÖ –î–∞—Ç–∞">
            
            <label class="file-btn" for="cover">üñºÔ∏è Cover</label>
            <input type="file" id="cover" accept="image/*">
            <img id="cover-preview" style="display: none;">

            <button class="danger" onclick="downloadFullTXT()">üìù TXT</button>
            <button class="danger" onclick="downloadEPUB()">‚¨áÔ∏è EPUB</button>
            <button class="info" onclick="downloadHTML()">üåê HTML</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-btn active" onclick="showTab('import')">üì• Import</button>
        <button class="tab-btn" onclick="showTab('chapters')">üìö Chapters</button>
        <button class="tab-btn" onclick="showTab('export')">üì§ Export</button>
    </div>
</div>

<!-- –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ò–Ø -->
<div id="rename-section">
    <div class="modal-content">
        <h3>Rename characters</h3>
        <div id="rename-fields" class="rename-grid"></div>
        <button class="primary" onclick="applyRenames(); closeModal()">‚úì Apply</button>
        <button class="secondary" onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
let state = {
    chapters: [],
    uniqueTags: new Set(),
    tagMap: {},
    cover: null
};
let logs = [];

function normalizeSpaces(text) {
    return text.replace(/\u00A0/g, ' ').replace(/\u2002/g, ' ').replace(/\u2003/g, ' ').replace(/  +/g, ' ').replace(/\u200B/g, '').trim();
}

function escapeHtml(text) {
    const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
    return text.replace(/[&<>"']/g, m => map[m]);
}

function stripHtmlTags(text) {
    return text.replace(/<[^>]*>/g, '');
}

function log(msg) {
    logs.push(msg);
    const logEl = document.getElementById('log');
    logEl.textContent = logs.join('\n');
    logEl.scrollTop = logEl.scrollHeight;
}

function clearLog() {
    logs = [];
    document.getElementById('log').textContent = '';
}

function showTab(name) {
    document.querySelectorAll('.tab-pane').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
    document.getElementById(name).classList.add('active');
    document.querySelector(`[onclick*="showTab('${name}')"]`).classList.add('active');
}

function closeModal() {
    document.getElementById('rename-section').classList.remove('show');
}

document.getElementById('file').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
        let text = evt.target.result;
        if (file.name.endsWith('.json')) {
            try {
                const json = JSON.parse(text);
                let msgs = Array.isArray(json) ? json : json.messages || json.data || json.chats || [];
                if (!msgs.length) for (let k in json) if (Array.isArray(json[k])) { msgs = json[k]; break; }
                text = msgs.map(m => typeof m === 'string' ? m : m.text || m.message || m.content || '').filter(t => t.trim()).join('\n');
            } catch(e) {}
        }
        document.getElementById('text').value = text;
        log('‚úì –§–∞–π–ª: ' + file.name);
    };
    reader.readAsText(file);
});

document.getElementById('cover').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = evt => {
        state.cover = evt.target.result;
        document.getElementById('cover-preview').src = evt.target.result;
        document.getElementById('cover-preview').style.display = 'block';
        log('‚úì –ü–æ—Å—Ç–µ—Ä –∑–∞–≥—Ä—É–∂–µ–Ω');
    };
    reader.readAsDataURL(file);
});

function processText() {
    const raw = document.getElementById('text').value.trim();
    if (!raw) { alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç!'); return; }
    
    state.chapters = [];
    state.uniqueTags = new Set();
    state.tagMap = {};
    
    let lines = raw.split('\n');
    let ch = null, content = [];
    
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i];
        let tagPrefix = '';
        if (/^\[.*\]:?\s*##\s+–ì–ª–∞–≤–∞/i.test(line)) {
            const tagMatch = line.match(/^(\[.*?\]:?)\s*(##\s+–ì–ª–∞–≤–∞.*)/i);
            if (tagMatch) { tagPrefix = tagMatch[1]; line = tagMatch[2]; }
        }
        if (/^##\s+–ì–ª–∞–≤–∞\s+\d+/i.test(line)) {
            if (ch) addChapter(ch, content.join('\n').trim());
            const titleText = line.replace(/^##\s+–ì–ª–∞–≤–∞\s+\d+\s*/i, '').trim();
            ch = titleText;
            content = [];
            if (tagPrefix) content.push(tagPrefix);
        } else if (ch) {
            content.push(line);
        }
    }
    if (ch) addChapter(ch, content.join('\n').trim());
    
    if (!state.chapters.length) { alert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ "## –ì–ª–∞–≤–∞ N"'); log('‚úó –ù–µ—Ç –≥–ª–∞–≤'); return; }
    
    log('‚úì –†–∞–∑–±–∏—Ç–æ: ' + state.chapters.length + ' –≥–ª–∞–≤');
    log('‚úì –¢–µ–≥–æ–≤: ' + state.uniqueTags.size);
    
    if (state.uniqueTags.size > 0) document.getElementById('rename-btn').style.display = 'block';
    renderChapters();
}

function addChapter(title, body) {
    const tags = [];
    const tagRe = /^\s*(\[[^\]]+\]:?)\s*/;
    while (tagRe.test(body)) {
        const m = body.match(tagRe);
        const tag = m[1].replace(/:$/, '');
        tags.push(tag);
        state.uniqueTags.add(tag);
        body = body.substring(m[0].length);
    }
    body = body.trim();
    let fullBody = body;
    if (tags.length) fullBody = tags.map(t => t + ': ').join('') + '\n\n' + body;
    state.chapters.push({ title: title, body: body, tags: tags, fullBody: fullBody });
}

function showRenameUI() {
    const fieldsDiv = document.getElementById('rename-fields');
    fieldsDiv.innerHTML = '';
    const tags = Array.from(state.uniqueTags);
    tags.forEach(tag => {
        const cleanTag = tag.replace(/[\[\]]/g, '');
        const label = document.createElement('label');
        label.textContent = tag + ':';
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = '–ù–æ–≤–æ–µ –∏–º—è...';
        input.id = 'rename-' + cleanTag;
        fieldsDiv.appendChild(label);
        fieldsDiv.appendChild(input);
    });
    document.getElementById('rename-section').classList.add('show');
    log('–í–≤–µ–¥–∏—Ç–µ –∏–º–µ–Ω–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π');
}

function applyRenames() {
    const tags = Array.from(state.uniqueTags);
    const newNames = {};
    tags.forEach(tag => {
        const cleanTag = tag.replace(/[\[\]]/g, '');
        const input = document.getElementById('rename-' + cleanTag);
        if (input && input.value.trim()) newNames[tag] = input.value.trim();
    });
    
    if (Object.keys(newNames).length === 0) { alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω–æ –∏–º—è!'); return; }
    
    state.chapters.forEach(ch => {
        let body = ch.fullBody;
        Object.keys(newNames).forEach(oldTag => {
            const newName = newNames[oldTag];
            const cleanOldTag = oldTag.replace(/[\[\]]/g, '').replace(/:$/, '');
            const replacement = '<b>' + newName + ':</b> ';
            body = body.replace(new RegExp('^\\s*\\[' + cleanOldTag + '\\]:\\s*', 'gm'), replacement);
            body = body.replace(new RegExp('^\\s*\\[' + cleanOldTag + '\\]\\s+', 'gm'), replacement);
            body = body.replace(new RegExp('^' + cleanOldTag + ':\\s*', 'gm'), replacement);
        });
        ch.fullBody = body;
        ch.body = body;
    });
    
    renderChapters();
    log('‚úì –¢–µ–≥–∏ –ø–µ—Ä–µ–∏–º–µ–Ω–æ–≤–∞–Ω—ã');
}

function formatText() {
    state.chapters.forEach(ch => {
        let body = ch.fullBody;
        let parts = body.split(/(<[^>]*>)/);
        parts = parts.map((part, idx) => {
            if (idx % 2 === 1) return part;
            let text = part;
            text = text.replace(/\\/g, '');
            text = text.replace(/_([^_]+)_/g, '$1');
            text = text.replace(/\/([^/]+)\//g, '$1');
            text = text.replace(/(\*(?!\*))([^\*]+)\1(?!\*)/g, '$2');
            text = text.replace(/"([^"]*)"/g, '¬´$1¬ª');
            text = text.replace(/(\n|\s)-\s/g, '$1‚Äî ');
            return text;
        });
        ch.fullBody = parts.join('');
        ch.body = ch.fullBody;
    });
    renderChapters();
    log('‚úì –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–æ');
}

function renderChapters() {
    const list = document.getElementById('chapters-list');
    list.innerHTML = '';
    state.chapters.forEach((ch, i) => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <h3>–ì–ª–∞–≤–∞ ${i+1}: ${ch.title}</h3>
            <div class="btn-group">
                <button onclick="downloadChapter(${i})" style="background: #333; color: #0dd; border: 1px solid #0dd;">üíæ</button>
                <button onclick="downloadChapterHTML(${i})" style="background: #333; color: #0dd; border: 1px solid #0dd;">üåê</button>
                <button onclick="deleteChapter(${i})" style="background: #333; color: #f55; border: 1px solid #f55;">üóëÔ∏è</button>
            </div>
            <textarea id="ch${i}" onchange="state.chapters[${i}].fullBody = this.value; state.chapters[${i}].body = this.value;" style="font-size: 12px; min-height: 80px;">${escapeHtml(ch.fullBody)}</textarea>
        `;
        list.appendChild(div);
    });
}

function downloadChapter(i) {
    const ch = state.chapters[i];
    let txt = ch.fullBody;
    txt = txt.replace(/\n(<b>[^<]+<\/b>)/g, '\n\n$1');
    txt = stripHtmlTags(txt);
    const header = '–ì–ª–∞–≤–∞ ' + (i+1) + ': ' + ch.title + '\n\n';
    txt = header + txt;
    const blob = new Blob([txt], { type: 'text/plain; charset=utf-8' });
    saveAs(blob, '–ì–ª–∞–≤–∞_' + (i+1) + '_' + ch.title + '.txt');
    log('‚úì –°–∫–∞—á–∞–Ω–∞ –≥–ª–∞–≤–∞ ' + (i+1));
}

function downloadChapterHTML(i) {
    const ch = state.chapters[i];
    const htmlBody = formatChapterForHTML(ch.fullBody);
    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${ch.title}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Georgia,serif;background:#f5f5f5;color:#333;padding:15px;font-size:16px;line-height:1.8}.container{max-width:600px;margin:0 auto;background:white;padding:25px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.1)}h1{font-size:24px;text-align:center;margin-bottom:5px}h2{font-size:20px;color:#333;margin:20px 0 10px 0}p{margin:15px 0;text-align:left;word-wrap:break-word}strong{font-weight:bold;color:#000}@media(max-width:600px){body{padding:10px}.container{padding:15px}h1{font-size:18px}p{font-size:14px}}</style></head><body><div class="container"><h2>${ch.title}</h2>${htmlBody}</div></body></html>`;
    const blob = new Blob([html], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = '–ì–ª–∞–≤–∞_' + (i+1) + '_' + ch.title + '.html';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    log('‚úì HTML —Å–∫–∞—á–∞–Ω');
}

function formatChapterForHTML(content) {
    const lines = content.split('\n');
    let html = '';
    for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue;
        const boldMatch = line.match(/^<b>([^<]+)<\/b>\s*(.*)$/);
        if (boldMatch) {
            const name = boldMatch[1];
            const rest = normalizeSpaces(boldMatch[2]);
            if (rest) html += '<p><strong>' + escapeHtml(name) + '</strong> ' + escapeHtml(rest) + '</p>';
            else html += '<p><strong>' + escapeHtml(name) + '</strong></p>';
        } else {
            const normalized = normalizeSpaces(escapeHtml(line));
            if (normalized) html += '<p>' + normalized + '</p>';
        }
    }
    return html;
}

function deleteChapter(i) {
    if (confirm('–£–¥–∞–ª–∏—Ç—å –ì–ª–∞–≤–∞ ' + (i+1) + '?')) {
        state.chapters.splice(i, 1);
        renderChapters();
        log('‚úì –£–¥–∞–ª–µ–Ω–∞ –≥–ª–∞–≤–∞ ' + (i+1));
    }
}

function downloadAllZip() {
    if (!state.chapters.length) { alert('–ù–µ—Ç –≥–ª–∞–≤!'); return; }
    const zip = new JSZip();
    state.chapters.forEach((ch, i) => {
        let txt = ch.fullBody;
        txt = txt.replace(/\n(<b>[^<]+<\/b>)/g, '\n\n$1');
        txt = stripHtmlTags(txt);
        const header = '–ì–ª–∞–≤–∞ ' + (i+1) + ': ' + ch.title + '\n\n';
        txt = header + txt;
        zip.file('–ì–ª–∞–≤–∞_' + (i+1) + '_' + ch.title + '.txt', txt);
    });
    zip.generateAsync({ type: 'blob' }).then(blob => {
        saveAs(blob, '–ö–Ω–∏–≥–∞_–≤—Å–µ_–≥–ª–∞–≤—ã.zip');
        log('‚úì ZIP —Å–∫–∞—á–∞–Ω');
    });
}

function downloadFullTXT() {
    if (!state.chapters.length) { alert('–ù–µ—Ç –≥–ª–∞–≤!'); return; }
    const title = document.getElementById('book-title').value || '–ö–Ω–∏–≥–∞';
    const author = document.getElementById('book-author').value || '';
    const date = document.getElementById('book-date').value || '';
    let txt = '';
    txt += title.toUpperCase() + '\n';
    if (author) txt += 'Author: ' + author + '\n';
    if (date) txt += '–î–∞—Ç–∞: ' + date + '\n';
    txt += '\n' + '='.repeat(60) + '\n\n';
    state.chapters.forEach((ch, i) => {
        txt += '–ì–õ–ê–í–ê ' + (i+1) + ': ' + ch.title.toUpperCase() + '\n\n';
        let chapterTxt = ch.fullBody;
        chapterTxt = chapterTxt.replace(/\n(<b>[^<]+<\/b>)/g, '\n\n$1');
        chapterTxt = stripHtmlTags(chapterTxt);
        txt += chapterTxt + '\n\n';
        txt += '-'.repeat(60) + '\n\n';
    });
    const blob = new Blob([txt], { type: 'text/plain; charset=utf-8' });
    saveAs(blob, title + '_–ø–æ–ª–Ω–∞—è_–∫–Ω–∏–≥–∞.txt');
    log('‚úì TXT —Å–∫–∞—á–∞–Ω');
}

function downloadEPUB() {
    if (!state.chapters.length) { alert('–ù–µ—Ç –≥–ª–∞–≤!'); return; }
    const zip = new JSZip();
    zip.file('mimetype', 'application/epub+zip');
    const meta = zip.folder('META-INF');
    meta.file('container.xml', `<?xml version="1.0"?><container version="1.0" xmlns="urn:oasis:names:tc:opendocument:xmlns:container"><rootfiles><rootfile full-path="OEBPS/content.opf" media-type="application/oebps-package+xml"/></rootfiles></container>`);
    const oebps = zip.folder('OEBPS');
    let manifest = '<item id="ncx" href="toc.ncx" media-type="application/x-dtbncx+xml"/>';
    let spine = '';
    state.chapters.forEach((_, i) => {
        manifest += `\n<item id="ch${i}" href="ch${i}.xhtml" media-type="application/xhtml+xml"/>`;
        spine += `\n<itemref idref="ch${i}"/>`;
    });
    const title = document.getElementById('book-title').value || '–ö–Ω–∏–≥–∞';
    const author = document.getElementById('book-author').value || '–ê–≤—Ç–æ—Ä';
    if (state.cover) {
        manifest += '\n<item id="cover-image" href="cover.png" media-type="image/png"/>';
        oebps.file('cover.png', state.cover.split(',')[1], { base64: true });
    }
    oebps.file('content.opf', `<?xml version="1.0" encoding="UTF-8"?><package xmlns="http://www.idpf.org/2007/opf" version="2.0" unique-identifier="uuid"><metadata xmlns:dc="http://purl.org/dc/elements/1.1/"><dc:title>${title}</dc:title><dc:creator>${author}</dc:creator></metadata><manifest>${manifest}</manifest><spine toc="ncx">${spine}</spine></package>`);
    let navMap = '';
    state.chapters.forEach((ch, i) => {
        navMap += `\n<navPoint id="ch${i}" playOrder="${i+1}"><navLabel><text>${ch.title}</text></navLabel><content src="ch${i}.xhtml"/></navPoint>`;
    });
    oebps.file('toc.ncx', `<?xml version="1.0"?><ncx xmlns="http://www.daisy.org/z3986/2005/ncx/" version="2005-1"><navMap>${navMap}</navMap></ncx>`);
    state.chapters.forEach((ch, i) => {
        const htmlBody = formatChapterForHTML(ch.fullBody);
        const xhtml = `<?xml version="1.0"?><html xmlns="http://www.w3.org/1999/xhtml"><head><title>${ch.title}</title><style>p{margin-bottom:1em;line-height:1.8}strong{font-weight:bold}</style></head><body><h2>${ch.title}</h2>${htmlBody}</body></html>`;
        oebps.file(`ch${i}.xhtml`, xhtml);
    });
    zip.generateAsync({ type: 'blob' }).then(blob => {
        saveAs(blob, title + '.epub');
        log('‚úì EPUB —Å–∫–∞—á–∞–Ω');
    });
}

function downloadHTML() {
    if (!state.chapters.length) { alert('–ù–µ—Ç –≥–ª–∞–≤!'); return; }
    const title = document.getElementById('book-title').value || '–ö–Ω–∏–≥–∞';
    const author = document.getElementById('book-author').value || '';
    let chaptersHtml = '';
    state.chapters.forEach(ch => {
        const htmlBody = formatChapterForHTML(ch.fullBody);
        chaptersHtml += `<h2>${ch.title}</h2>${htmlBody}`;
    });
    let html = `<!DOCTYPE html><html><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>${title}</title><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:Georgia,serif;background:#f5f5f5;color:#333;padding:15px}
.container{max-width:900px;margin:0 auto;background:white;padding:40px;border-radius:8px;box-shadow:0 2px 15px rgba(0,0,0,0.1)}
h1{text-align:center;font-size:32px;margin-bottom:20px}
.metadata{text-align:center;border-bottom:2px solid #ddd;padding-bottom:20px;margin-bottom:30px}
.author{font-size:18px;color:#666;margin-bottom:10px}
.date{font-size:14px;color:#999}
h2{margin-top:40px;margin-bottom:20px;border-bottom:1px solid #ddd;padding-bottom:10px;font-size:24px}
p{margin-bottom:15px;font-size:16px;line-height:1.8;text-align:left}
strong{font-weight:bold;color:#000}
img{max-width:300px;height:auto;display:block;margin:20px auto;border-radius:4px}
@media(max-width:768px){.container{padding:20px}h1{font-size:24px}h2{font-size:18px}p{font-size:14px}}</style></head><body><div class="container">`;
    if (state.cover) html += `<img src="${state.cover}" alt="–û–±–ª–æ–∂–∫–∞">`;
    html += `<h1>${title}</h1><div class="metadata">`;
    if (author) html += `<div class="author">${author}</div>`;
    const date = document.getElementById('book-date').value;
    if (date) html += `<div class="date">${date}</div>`;
    html += `</div><div class="content">${chaptersHtml}</div></div></body></html>`;
    const blob = new Blob([html], { type: 'application/octet-stream' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = title + '.html';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
    log('‚úì HTML —Å–∫–∞—á–∞–Ω');
}

function clearAll() {
    if (confirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—ë?')) {
        state = { chapters: [], uniqueTags: new Set(), tagMap: {}, cover: null };
        document.getElementById('text').value = '';
        document.getElementById('chapters-list').innerHTML = '';
        document.getElementById('rename-btn').style.display = 'none';
        log('‚úì –û—á–∏—â–µ–Ω–æ');
    }
}
</script>

</body>
</html>
